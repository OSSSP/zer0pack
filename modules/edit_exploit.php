<?php
include('include/xmwrite.php');
include('include/mysql_connect.php');
if(isset($_POST['create'])) {
if(empty($_POST['name']) OR empty($_POST['payload']) OR empty($_POST['browser']) OR empty($_POST['version']) OR empty($_POST['code']) OR empty($_POST['file'])) {
	$error="You have to fill all fields out!";
} elseif(strpos(urldecode($_POST['file']),"/")!==false) {
		$error="Illegal filename!";
} elseif($_POST['name']!=mysql_escape_string(htmlspecialchars($_POST['name']))) {
		$error="Illegal character in field 'name'!";
} else {
$sql = 'DELETE FROM `'._PREFIX_.'xmodules` WHERE `filename` = \''.mysql_escape_string($_GET['edit']).'\'';
unlink("xmodules/".$_GET['edit']);
mysql_query($sql) OR die(mysql_error());
$xm= new xmwrite($_POST['name'], $_POST['payload'], $_POST['browser'], $_POST['version'], $_POST['code'], $_POST['file'].".xm", $_POST['active']);
if($xm==0) {
	$error="A file with this name already exists!";
} else {
$msg="Settings saved!";
}
}
}
if(isset($_GET['edit'])) {
	if(strpos(urldecode($_POST['edit']),"/")!=false) {
		die("Don't even think about that.");
	}
	include('include/xmread.php');
	$xr=new xmread('xmodules/'.$_GET['edit']);
	$file=explode('.', $_GET['edit']);
	echo '<h1>Edit Exploit</h1><br>
	<form method=POST>
	<b>NOTE: Mark the Shellcodeposition with: <i>#!shellcode!#</i></b><br>
			Exploit Name:	<input payload=text name=name size="60" maxlength="100" value="'.$xr->name.'"><br>
	Payload Type:<input type=text name=payload maxlength="50" value="'.$xr->payload.'"><br> <i>example: #!shellcode!# or #!file!#</i><br>
			browser Browser:	<input type=text name=browser maxlength="50" value="'.$xr->browser.'"><br>
			browser Version:	<font size=4>/^</font></b><input type=text name=version maxlength="50" value="'.$xr->version.'">&nbsp;<i>RegExp Supported! (/^1.0.[0-9]/)</i><br>
	Code:	<br><textarea name=code cols=60 rows=10 >'.$xr->code.'</textarea><br>
	Output File (*.xm):<input type=text name=file maxlength="30" value="'.$file[0].'"><br>
	<input type="hidden" name="active" value="'.htmlspecialchars($_GET['active']).'">
	<input type=submit name=create value=save><br><br>
	</form>';
}
